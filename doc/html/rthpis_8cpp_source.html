<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>MNE-CPP: C:/Git/mne-cpp/MNE/rtInv/rthpis.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MNE-CPP
   &#160;<span id="projectnumber">beta 1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_fba7b6d30909f9ec66000534e18b073e.html">MNE</a></li><li class="navelem"><a class="el" href="dir_033466febd60a68f23401bec31fff635.html">rtInv</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">rthpis.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="rthpis_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">//=============================================================================================================</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment"></span><span class="comment">//*************************************************************************************************************</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment">//=============================================================================================================</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment">// INCLUDES</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment">//=============================================================================================================</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">#include &lt;Eigen/Dense&gt;</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="rthpis_8h.html">rthpis.h</a>&quot;</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="fiff__cov_8h.html">fiff/fiff_cov.h</a>&gt;</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="comment">//*************************************************************************************************************</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="comment">//=============================================================================================================</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="comment">// QT INCLUDES</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="comment">//=============================================================================================================</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="preprocessor">#include &lt;QDebug&gt;</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="comment">//*************************************************************************************************************</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="comment">//=============================================================================================================</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="comment">// USED NAMESPACES</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="comment">//=============================================================================================================</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="keyword">using namespace </span><a class="code" href="namespace_r_t_i_n_v_l_i_b.html">RTINVLIB</a>;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="keyword">using namespace </span><a class="code" href="namespace_f_i_f_f_l_i_b.html">FIFFLIB</a>;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="comment">//*************************************************************************************************************</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="comment">//=============================================================================================================</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="comment">// DEFINE MEMBER METHODS</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="comment">//=============================================================================================================</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div>
<div class="line"><a name="l00073"></a><span class="lineno"><a class="line" href="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s.html#a8f482816342d7e85c7d5fa3e592c486b">   73</a></span>&#160;<a class="code" href="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s.html#a8f482816342d7e85c7d5fa3e592c486b">RtHPIS::RtHPIS</a>(<a class="code" href="class_f_i_f_f_l_i_b_1_1_fiff_info.html#abfce6128814de61b3fdd324a97918338">FiffInfo::SPtr</a> p_pFiffInfo, QObject *parent)</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;: QThread(parent)</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;, m_pFiffInfo(p_pFiffInfo)</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;, m_bIsRunning(false)</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;{</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    qRegisterMetaType&lt;Eigen::MatrixXd&gt;(<span class="stringliteral">&quot;Eigen::MatrixXd&quot;</span>);</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="comment">//qRegisterMetaType&lt;QVector&lt;double&gt;&gt;(&quot;QVector&lt;double&gt;&quot;);</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    SendDataToBuffer = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;}</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="comment">//*************************************************************************************************************</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div>
<div class="line"><a name="l00087"></a><span class="lineno"><a class="line" href="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s.html#a8bf331e20556363f55a76c91f36e704b">   87</a></span>&#160;<a class="code" href="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s.html#a8bf331e20556363f55a76c91f36e704b">RtHPIS::~RtHPIS</a>()</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;{</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    <span class="keywordflow">if</span>(this-&gt;<a class="code" href="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s.html#a3ea8e716042e66608367190f19244a2a">isRunning</a>()){</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;        <a class="code" href="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s.html#a990146f0f4a71f08116a4602d1d5918e">stop</a>();</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    }</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;}</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="comment">//*************************************************************************************************************</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div>
<div class="line"><a name="l00097"></a><span class="lineno"><a class="line" href="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s.html#a708952fe3f8738f99d383d8c8d136827">   97</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s.html#a708952fe3f8738f99d383d8c8d136827">RtHPIS::append</a>(<span class="keyword">const</span> MatrixXd &amp;p_DataSegment)</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;{</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    <span class="keywordflow">if</span>(!m_pRawMatrixBuffer)</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;        m_pRawMatrixBuffer = <a class="code" href="class_i_o_buffer_1_1_circular_matrix_buffer.html#a27289313f8c9d93db4e02703e2033e8f">CircularMatrixBuffer&lt;double&gt;::SPtr</a>(<span class="keyword">new</span> <a class="code" href="class_i_o_buffer_1_1_circular_matrix_buffer.html">CircularMatrixBuffer&lt;double&gt;</a>(8, p_DataSegment.rows(), p_DataSegment.cols()));</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    <span class="keywordflow">if</span> (SendDataToBuffer)</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;        m_pRawMatrixBuffer-&gt;<a class="code" href="class_i_o_buffer_1_1_circular_matrix_buffer.html#adbba1720803e03e6b1bcd6b37f884f09">push</a>(&amp;p_DataSegment);</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;}</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="comment">//*************************************************************************************************************</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;</div>
<div class="line"><a name="l00109"></a><span class="lineno"><a class="line" href="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s.html#a5df30063b75193a9b2cb50058d68cc41">  109</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s.html#a5df30063b75193a9b2cb50058d68cc41">RtHPIS::start</a>()</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;{</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    <span class="comment">//Check if the thread is already or still running. This can happen if the start button is pressed immediately after the stop button was pressed. In this case the stopping process is not finished yet but the start process is initiated.</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    <span class="keywordflow">if</span>(this-&gt;<a class="code" href="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s.html#a3ea8e716042e66608367190f19244a2a">isRunning</a>())</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        QThread::wait();</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    m_bIsRunning = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    QThread::start();</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;}</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="comment">//*************************************************************************************************************</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div>
<div class="line"><a name="l00124"></a><span class="lineno"><a class="line" href="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s.html#a990146f0f4a71f08116a4602d1d5918e">  124</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s.html#a990146f0f4a71f08116a4602d1d5918e">RtHPIS::stop</a>()</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;{</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    m_bIsRunning = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    m_pRawMatrixBuffer-&gt;<a class="code" href="class_i_o_buffer_1_1_circular_matrix_buffer.html#a2a2115cde980084c54c138b00b3a2273">releaseFromPop</a>();</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    m_pRawMatrixBuffer-&gt;<a class="code" href="class_i_o_buffer_1_1_circular_matrix_buffer.html#af61689beb6325a34564e76ccc674487a">clear</a>();</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    qDebug()&lt;&lt;<span class="stringliteral">&quot; RtHPIS Thread is stopped.&quot;</span>;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;}</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="comment">//*************************************************************************************************************</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div>
<div class="line"><a name="l00140"></a><span class="lineno"><a class="line" href="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s.html#a006c97dcf82c0654a63c75a5857887de">  140</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s.html#a006c97dcf82c0654a63c75a5857887de">RtHPIS::run</a>()</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;{</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    <span class="keyword">struct </span><a class="code" href="struct_r_t_i_n_v_l_i_b_1_1sens.html">sens</a> sensors;</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    <span class="keyword">struct </span><a class="code" href="struct_r_t_i_n_v_l_i_b_1_1coil_param.html">coilParam</a> coil;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    <span class="keywordtype">int</span> numCoils = 4;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <span class="keywordtype">int</span> numCh = m_pFiffInfo-&gt;nchan;</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    <span class="keywordtype">int</span> samF = m_pFiffInfo-&gt;sfreq;</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    <span class="keywordtype">int</span> numLoc = 1, numBlock, samLoc; <span class="comment">// numLoc : Number of times to localize in a second</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    samLoc = samF/numLoc; <span class="comment">// minimum samples required to localize numLoc times in a second</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    Eigen::VectorXd coilfreq(numCoils);</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    coilfreq[0] = 154;coilfreq[1] = 158;coilfreq[2] = 162;coilfreq[3] = 166;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    <span class="comment">// Initialize HPI coils location and moment</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    coil.pos = Eigen::MatrixXd::Zero(numCoils,3);</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    coil.mom = Eigen::MatrixXd::Zero(numCoils,3);</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    <span class="comment">// Generate simulated data</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    Eigen::MatrixXd simsig(samLoc,numCoils*2);</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    Eigen::VectorXd time(samLoc);</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0;i &lt; samLoc;i++) time[i] = i*1.0/samF;</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;numCoils;i++) {</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;samLoc;j++) {</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;            simsig(j,i) = sin(2*M_PI*coilfreq[i]*time[j]);</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;            simsig(j,i+numCoils) = cos(2*M_PI*coilfreq[i]*time[j]);</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        }</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    }</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <span class="comment">// Get the indices of inner layer channels</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    QVector&lt;int&gt; innerind(0);</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0;i &lt; numCh;i++) {</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        <span class="keywordflow">if</span>(m_pFiffInfo-&gt;chs[i].coil_type == 7002) {</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;            <span class="comment">// Check if the sensor is bad, if not append to innerind</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;            <span class="keywordflow">if</span>(!(m_pFiffInfo-&gt;bads.contains(m_pFiffInfo-&gt;ch_names.at(i)))) innerind.append(i);</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        }</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    }</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    <span class="comment">// Initialize inner layer sensors</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    sensors.coilpos = Eigen::MatrixXd::Zero(innerind.size(),3);</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    sensors.coilori = Eigen::MatrixXd::Zero(innerind.size(),3);</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    sensors.tra = Eigen::MatrixXd::Identity(innerind.size(),innerind.size());</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;innerind.size();i++) {</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        sensors.coilpos(i,0) = m_pFiffInfo-&gt;chs[innerind.at(i)].loc(0,0);</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        sensors.coilpos(i,1) = m_pFiffInfo-&gt;chs[innerind.at(i)].loc(1,0);</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        sensors.coilpos(i,2) = m_pFiffInfo-&gt;chs[innerind.at(i)].loc(2,0);</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        sensors.coilori(i,0) = m_pFiffInfo-&gt;chs[innerind.at(i)].loc(9,0);</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        sensors.coilori(i,1) = m_pFiffInfo-&gt;chs[innerind.at(i)].loc(10,0);</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;        sensors.coilori(i,2) = m_pFiffInfo-&gt;chs[innerind.at(i)].loc(11,0);</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    }</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    <span class="comment">//load polhemus HPI</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    Eigen::MatrixXd headHPI(numCoils,3);</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    <span class="comment">// check the m_pFiffInfo-&gt;dig information. If dig is empty, set the headHPI is 0;</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    <span class="keywordflow">if</span> (m_pFiffInfo-&gt;dig.size()&gt;0)</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    {</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;numCoils;i++) {</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;            headHPI(i,0) = m_pFiffInfo-&gt;dig.at(i+3).r[0];headHPI(i,1) = m_pFiffInfo-&gt;dig.at(i+3).r[1];headHPI(i,2) = m_pFiffInfo-&gt;dig.at(i+3).r[2];</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;        }</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    }</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    {</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;numCoils;i++) {</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;            headHPI(i,0) = 0;headHPI(i,1) = 0;headHPI(i,2) = 0;</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        }</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        qDebug()&lt;&lt; <span class="stringliteral">&quot;Forget to load polhemus HPI! Please stop running and load it again!&quot;</span>;</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    }</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    Eigen::MatrixXd topo(innerind.size(),numCoils*2);</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    Eigen::MatrixXd amp(innerind.size(),numCoils);</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    Eigen::Matrix4d trans;</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    QVector&lt;MatrixXd&gt; buffer;</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <span class="keywordtype">double</span> phase;</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    <span class="keywordflow">while</span>(m_bIsRunning)</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    {</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        <span class="keywordflow">if</span>(m_pRawMatrixBuffer)</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        {</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;            MatrixXd t_mat = m_pRawMatrixBuffer-&gt;<a class="code" href="class_i_o_buffer_1_1_circular_matrix_buffer.html#ad22568c8be8da160dd52a98cf5f4fd46">pop</a>();</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;            buffer.append(t_mat);</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;            <span class="keywordflow">if</span>(buffer.size()*t_mat.cols() &gt;= samLoc) {</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;                Eigen::MatrixXd alldata(t_mat.rows(),buffer.size()*t_mat.cols());</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                <span class="comment">// Concatenate data into a matrix</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;                <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;buffer.size();i++) alldata &lt;&lt; buffer[i];</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;                <span class="comment">// Get the data from inner layer channels</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;                Eigen::MatrixXd innerdata(innerind.size(),samLoc);</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;                numBlock = alldata.cols()/samLoc;</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;                <span class="comment">// Loop for localizing coils</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0;i&lt;numBlock;i++) {</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;                    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j = 0;j &lt; innerind.size();j++)</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;                        innerdata.row(j) &lt;&lt; alldata.block(innerind[j],i*samLoc,1,samLoc);</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;                    topo = innerdata * pinv(simsig).transpose();</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                    amp = (topo.leftCols(numCoils).array().square() + topo.rightCols(numCoils).array().square()).array().sqrt();</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0;i &lt; numCoils;i++) {</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;                        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0;j &lt; innerind.size();j++) {</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                            phase = atan2(topo(j,i+numCoils),topo(j,i)) * 180/M_PI;</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                            <span class="keywordflow">if</span>(phase &lt; 0) phase = 360 + phase;</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                            <span class="keywordflow">if</span>(phase &lt;= 90) phase = 1;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(phase &gt; 90 || phase &lt;= 270) phase = -1;</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;                            <span class="keywordflow">else</span> phase = 1;</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;                            amp(j,i) = amp(j,i) * phase;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;                        }</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;                    }</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;                    coil = dipfit(coil, sensors, amp, numCoils);</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;                    qDebug()&lt;&lt;<span class="stringliteral">&quot;HPI head &quot;</span>&lt;&lt;headHPI(0,0)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;headHPI(0,1)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;headHPI(0,2);</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;                    qDebug()&lt;&lt;<span class="stringliteral">&quot;HPI head &quot;</span>&lt;&lt;headHPI(1,0)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;headHPI(1,1)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;headHPI(1,2);</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                    qDebug()&lt;&lt;<span class="stringliteral">&quot;HPI head &quot;</span>&lt;&lt;headHPI(2,0)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;headHPI(2,1)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;headHPI(2,2);</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                    qDebug()&lt;&lt;<span class="stringliteral">&quot;HPI head &quot;</span>&lt;&lt;headHPI(3,0)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;headHPI(3,1)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;headHPI(3,2);</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;                    qDebug()&lt;&lt;<span class="stringliteral">&quot;HPI device &quot;</span>&lt;&lt;coil.pos(0,0)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;coil.pos(0,1)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;coil.pos(0,2);</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;                    qDebug()&lt;&lt;<span class="stringliteral">&quot;HPI device &quot;</span>&lt;&lt;coil.pos(1,0)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;coil.pos(1,1)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;coil.pos(1,2);</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;                    qDebug()&lt;&lt;<span class="stringliteral">&quot;HPI device &quot;</span>&lt;&lt;coil.pos(2,0)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;coil.pos(2,1)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;coil.pos(2,2);</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                    qDebug()&lt;&lt;<span class="stringliteral">&quot;HPI device &quot;</span>&lt;&lt;coil.pos(3,0)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;coil.pos(3,1)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;coil.pos(3,2);</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                    trans = computeTransformation(coil.pos,headHPI);</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;                    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ti =0; ti&lt;4;ti++)</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;                        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> tj=0;tj&lt;4;tj++)</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;                    m_pFiffInfo-&gt;dev_head_t.trans(ti,tj) = trans(ti,tj);</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;                }</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;                buffer.clear();</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;            }</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;        }<span class="comment">//m_pRawMatrixBuffer</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    } <span class="comment">//m_bIsRunning</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;}</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="comment">//*************************************************************************************************************</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="keywordtype">void</span> RtHPIS::test()</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;{</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    <span class="keyword">struct </span><a class="code" href="struct_r_t_i_n_v_l_i_b_1_1sens.html">sens</a> sensors;</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;    <span class="keyword">struct </span><a class="code" href="struct_r_t_i_n_v_l_i_b_1_1coil_param.html">coilParam</a> coil;</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    <span class="keywordtype">int</span> numCoils = 4;</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    <span class="keywordtype">int</span> numCh = m_pFiffInfo-&gt;nchan;</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    <span class="keywordtype">int</span> samF = m_pFiffInfo-&gt;sfreq;</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    <span class="keywordtype">int</span> numLoc = 3, numBlock, samLoc; <span class="comment">// numLoc : Number of times to localize in a second</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    samLoc = samF/numLoc; <span class="comment">// minimum samples required to localize numLoc times in a second</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    Eigen::VectorXd coilfreq(numCoils);</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    coilfreq[0] = 154;coilfreq[1] = 158;coilfreq[2] = 162;coilfreq[3] = 166;</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    <span class="comment">// Initialize HPI coils location and moment</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    coil.pos = Eigen::MatrixXd::Zero(numCoils,3);</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    coil.mom = Eigen::MatrixXd::Zero(numCoils,3);</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    <span class="comment">// Generate simulated data</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    Eigen::MatrixXd simreal(numCoils,samLoc);</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    Eigen::MatrixXd simimag(numCoils,samLoc);</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    Eigen::VectorXd time(samLoc);</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0;i &lt; samLoc;i++) time[i] = i*1.0/samF;</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    <span class="keywordtype">double</span> coilnorm;</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;numCoils;i++) {</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;samLoc;j++) {</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;            simreal(i,j) = cos(2*M_PI*coilfreq[i]*time[j]);</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;            simimag(i,j) = sin(2*M_PI*coilfreq[i]*time[j]);</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;        }</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;        coilnorm = sqrt((simreal.row(i).array().square() + simimag.row(i).array().square()).array().sum());</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;        simreal.row(i) = simreal.row(i) / coilnorm;</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;        simimag.row(i) = simimag.row(i) / coilnorm;</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    }</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    <span class="comment">// Get the indices of reference channels</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    QVector&lt;int&gt; refind(0);</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    <span class="keywordflow">if</span> (m_pFiffInfo-&gt;ch_names.indexOf(<span class="stringliteral">&quot;TRG013&quot;</span>,0) &gt;= 0) refind.append(m_pFiffInfo-&gt;ch_names.indexOf(<span class="stringliteral">&quot;TRG009&quot;</span>,0)+1);</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    <span class="keywordflow">if</span> (m_pFiffInfo-&gt;ch_names.indexOf(<span class="stringliteral">&quot;TRG014&quot;</span>,0) &gt;= 0) refind.append(m_pFiffInfo-&gt;ch_names.indexOf(<span class="stringliteral">&quot;TRG010&quot;</span>,0)+1);</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    <span class="keywordflow">if</span> (m_pFiffInfo-&gt;ch_names.indexOf(<span class="stringliteral">&quot;TRG015&quot;</span>,0) &gt;= 0) refind.append(m_pFiffInfo-&gt;ch_names.indexOf(<span class="stringliteral">&quot;TRG011&quot;</span>,0)+1);</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;    <span class="keywordflow">if</span> (m_pFiffInfo-&gt;ch_names.indexOf(<span class="stringliteral">&quot;TRG016&quot;</span>,0) &gt;= 0) refind.append(m_pFiffInfo-&gt;ch_names.indexOf(<span class="stringliteral">&quot;TRG012&quot;</span>,0)+1);</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    <span class="comment">// Get the indices of inner layer channels</span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    QVector&lt;int&gt; innerind(0);</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0;i &lt; numCh;i++) {</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        <span class="keywordflow">if</span>(m_pFiffInfo-&gt;chs[i].coil_type == 7002) {</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;            <span class="comment">// Check if the sensor is bad, if not append to innerind</span></div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;            <span class="keywordflow">if</span>(!(m_pFiffInfo-&gt;bads.contains(m_pFiffInfo-&gt;ch_names.at(i)))) innerind.append(i);</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        }</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    }</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    <span class="comment">// Initialize inner layer sensors</span></div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    sensors.coilpos = Eigen::MatrixXd::Zero(innerind.size(),3);</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    sensors.coilori = Eigen::MatrixXd::Zero(innerind.size(),3);</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    sensors.tra = Eigen::MatrixXd::Identity(innerind.size(),innerind.size());</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;innerind.size();i++) {</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        sensors.coilpos(i,0) = m_pFiffInfo-&gt;chs[innerind.at(i)].loc(0,0);</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        sensors.coilpos(i,1) = m_pFiffInfo-&gt;chs[innerind.at(i)].loc(1,0);</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;        sensors.coilpos(i,2) = m_pFiffInfo-&gt;chs[innerind.at(i)].loc(2,0);</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        sensors.coilori(i,0) = m_pFiffInfo-&gt;chs[innerind.at(i)].loc(9,0);</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        sensors.coilori(i,1) = m_pFiffInfo-&gt;chs[innerind.at(i)].loc(10,0);</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        sensors.coilori(i,2) = m_pFiffInfo-&gt;chs[innerind.at(i)].loc(11,0);</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    }</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    <span class="comment">//load polhemus HPI</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    Eigen::MatrixXd headHPI(numCoils,3);</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    <span class="comment">// check the m_pFiffInfo-&gt;dig information. If dig is empty, set the headHPI is 0;</span></div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    <span class="keywordflow">if</span> (m_pFiffInfo-&gt;dig.size()&gt;0)</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    {</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;numCoils;i++) {</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;            headHPI(i,0) = m_pFiffInfo-&gt;dig.at(i+3).r[0];</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;            headHPI(i,1) = m_pFiffInfo-&gt;dig.at(i+3).r[1];</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;            headHPI(i,2) = m_pFiffInfo-&gt;dig.at(i+3).r[2];</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;        }</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    }</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    {</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;numCoils;i++) {</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;            headHPI(i,0) = 0;</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;            headHPI(i,1) = 0;</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;            headHPI(i,2) = 0;</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;        }</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;        qDebug()&lt;&lt; <span class="stringliteral">&quot;Forget to load polhemus HPI! Please stop running and load it again!&quot;</span>;</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    }</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    Eigen::MatrixXd ampreal(innerind.size(),numCoils);</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    Eigen::MatrixXd ampimag(innerind.size(),numCoils);</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;    Eigen::Matrix4d trans;</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    Eigen::MatrixXd phasereal(1,samLoc);</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;    Eigen::MatrixXd phaseimag(1,samLoc);</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    Eigen::MatrixXd ampl(1,samLoc);</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    QVector&lt;MatrixXd&gt; buffer;</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    <span class="keywordflow">while</span>(m_bIsRunning)</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    {</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;        <span class="keywordflow">if</span>(m_pRawMatrixBuffer)</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;        {</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;            MatrixXd t_mat = m_pRawMatrixBuffer-&gt;<a class="code" href="class_i_o_buffer_1_1_circular_matrix_buffer.html#ad22568c8be8da160dd52a98cf5f4fd46">pop</a>();</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;            buffer.append(t_mat);</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;            <span class="keywordflow">if</span>(buffer.size()*t_mat.cols() &gt;= samLoc) {</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;                Eigen::MatrixXd alldata(t_mat.rows(),buffer.size()*t_mat.cols());</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;                <span class="comment">// Concatenate data into a matrix</span></div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;                <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;buffer.size();i++) alldata &lt;&lt; buffer[i];</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;                <span class="comment">// Get the data from inner layer channels</span></div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;                Eigen::MatrixXd innerdata(innerind.size(),samLoc);</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;                Eigen::MatrixXd refdata(numCoils,samLoc);</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;                numBlock = alldata.cols()/samLoc;</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                <span class="comment">// Loop for localizing coils</span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;                <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0;i&lt;numBlock;i++) {</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j = 0;j &lt; innerind.size();j++) {</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;                        std::cout &lt;&lt; innerind[j] &lt;&lt; std::endl;</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                        innerdata.row(j) &lt;&lt; alldata.block(innerind[j],i*samLoc,1,samLoc);</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                    }</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;                    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j = 0;j &lt; refind.size();j++)</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;                        refdata.row(j) &lt;&lt; alldata.block(refind[j],i*samLoc,1,samLoc);</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;                    ampreal = innerdata*simreal.transpose();</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;                    ampimag = innerdata*simimag.transpose()*-1;</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;                    phasereal = (refdata.array() * simreal.array()).array().colwise().sum();</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;                    phaseimag = (refdata.array() * simimag.array()).array().colwise().sum();</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;                    ampl = sqrt(phasereal.array().square() + phaseimag.array().square());</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;                    phasereal = phasereal.array() / ampl.array();</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;                    phaseimag = phaseimag.array() / ampl.array();</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;                    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0;i &lt; numCoils;i++)</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;                        ampreal.col(i).array() = ampreal.col(i) * phasereal(i) - ampimag.col(i) * phaseimag(i);</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;<span class="comment">//                    for(int i = 0;i&lt;innerdata.rows();i++) {</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;<span class="comment">//                        for(int j=0;j&lt;4;j++) {</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;<span class="comment">//                            std::cout&lt;&lt;innerdata(i,j)&lt;&lt; &quot;  &quot;;</span></div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;<span class="comment">//                        }</span></div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;<span class="comment">//                        std::cout &lt;&lt; std::endl;</span></div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;<span class="comment">//                     }</span></div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;<span class="comment">//                    std::cout &lt;&lt; ampreal.rows() &lt;&lt; std::endl;</span></div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;<span class="comment">//                    std::cout &lt;&lt; ampreal.cols() &lt;&lt; std::endl;</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;                    coil = dipfit(coil, sensors, ampreal, numCoils);</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;                    qDebug()&lt;&lt;<span class="stringliteral">&quot;HPI head &quot;</span>&lt;&lt;headHPI(0,0)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;headHPI(0,1)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;headHPI(0,2);</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;                    qDebug()&lt;&lt;<span class="stringliteral">&quot;HPI head &quot;</span>&lt;&lt;headHPI(1,0)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;headHPI(1,1)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;headHPI(1,2);</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                    qDebug()&lt;&lt;<span class="stringliteral">&quot;HPI head &quot;</span>&lt;&lt;headHPI(2,0)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;headHPI(2,1)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;headHPI(2,2);</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;                    qDebug()&lt;&lt;<span class="stringliteral">&quot;HPI head &quot;</span>&lt;&lt;headHPI(3,0)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;headHPI(3,1)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;headHPI(3,2);</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;                    qDebug()&lt;&lt;<span class="stringliteral">&quot;HPI device &quot;</span>&lt;&lt;coil.pos(0,0)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;coil.pos(0,1)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;coil.pos(0,2);</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;                    qDebug()&lt;&lt;<span class="stringliteral">&quot;HPI device &quot;</span>&lt;&lt;coil.pos(1,0)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;coil.pos(1,1)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;coil.pos(1,2);</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                    qDebug()&lt;&lt;<span class="stringliteral">&quot;HPI device &quot;</span>&lt;&lt;coil.pos(2,0)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;coil.pos(2,1)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;coil.pos(2,2);</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;                    qDebug()&lt;&lt;<span class="stringliteral">&quot;HPI device &quot;</span>&lt;&lt;coil.pos(3,0)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;coil.pos(3,1)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;coil.pos(3,2);</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;                    trans = computeTransformation(coil.pos,headHPI);</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;                    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ti =0; ti&lt;4;ti++)</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;                        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> tj=0;tj&lt;4;tj++)</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;                    m_pFiffInfo-&gt;dev_head_t.trans(ti,tj) = trans(ti,tj);</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;                }</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                buffer.clear();</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;            }</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;        }<span class="comment">//m_pRawMatrixBuffer</span></div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    } <span class="comment">//m_bIsRunning</span></div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;}</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="comment">/*********************************************************************************</span></div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;<span class="comment"> * dipfit function is adapted from Fieldtrip Software. It has been</span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;<span class="comment"> * heavily edited for use with MNE-X Software</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;<span class="comment"> *********************************************************************************/</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;<a class="code" href="struct_r_t_i_n_v_l_i_b_1_1coil_param.html">coilParam</a> RtHPIS::dipfit(<span class="keyword">struct</span> <a class="code" href="struct_r_t_i_n_v_l_i_b_1_1coil_param.html">coilParam</a> coil, <span class="keyword">struct</span> <a class="code" href="struct_r_t_i_n_v_l_i_b_1_1sens.html">sens</a> sensors, Eigen::MatrixXd data, <span class="keywordtype">int</span> numCoils)</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;{</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    <span class="comment">// Initialize variables</span></div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    <span class="keywordtype">int</span> display = 0;</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;    <span class="keywordtype">int</span> maxiter = 100;</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;    <a class="code" href="struct_r_t_i_n_v_l_i_b_1_1dip_error.html">dipError</a> temp;</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0;i&lt;numCoils;i++) {</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;        coil.pos.row(i).array() = fminsearch(coil.pos.row(i), maxiter, 2 * maxiter * coil.pos.cols(), display, data.col(i), sensors);</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;        temp = dipfitError(coil.pos.row(i), data.col(i), sensors);</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;        coil.mom = temp.moment.transpose();</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;    }</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;    <span class="keywordflow">return</span> coil;</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;}</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;<span class="comment">/*********************************************************************************</span></div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;<span class="comment"> * fminsearch Multidimensional unconstrained nonlinear minimization (Nelder-Mead).</span></div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;<span class="comment"> * X = fminsearch(X0, maxiter, maxfun, display, data, sensors) starts at X0 and</span></div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;<span class="comment"> * attempts to find a local minimizer</span></div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;<span class="comment"> *********************************************************************************/</span></div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;Eigen::MatrixXd RtHPIS::fminsearch(Eigen::MatrixXd pos,<span class="keywordtype">int</span> maxiter, <span class="keywordtype">int</span> maxfun, <span class="keywordtype">int</span> display, Eigen::MatrixXd data, <span class="keyword">struct</span> <a class="code" href="struct_r_t_i_n_v_l_i_b_1_1sens.html">sens</a> sensors)</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;{</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;    <span class="keywordtype">double</span> tolx, tolf, rho, chi, psi, sigma, func_evals, usual_delta, zero_term_delta, temp1, temp2;</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;    std::string header, how;</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;    <span class="keywordtype">int</span> n, itercount, prnt;</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;    Eigen::MatrixXd onesn, two2np1, one2n, v, y, v1, tempX1, tempX2, xbar, xr, x, xe, xc, xcc, xin;</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;    std::vector &lt;double&gt; fv, fv1;</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;    std::vector &lt;int&gt; idx;</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    <a class="code" href="struct_r_t_i_n_v_l_i_b_1_1dip_error.html">dipError</a> tempdip, fxr, fxe, fxc, fxcc;</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;    tolx = tolf = 1e-4;</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;    <span class="keywordflow">switch</span>(display)</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;    {</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;        <span class="keywordflow">case</span> 0:</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;            prnt = 0;</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;        <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;            prnt = 1;</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    }</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;    header = <span class="stringliteral">&quot; Iteration   Func-count     min f(x) Procedure&quot;</span>;</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    n = pos.cols();</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    <span class="comment">// Initialize parameters</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    rho = 1; chi = 2; psi = 0.5; sigma = 0.5;</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;    onesn = Eigen::MatrixXd::Ones(1,n);</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;    two2np1 = one2n = Eigen::MatrixXd::Zero(1,n);</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0;i &lt; n;i++) {</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;        two2np1(i) = 1 + i;</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;        one2n(i) = i;</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;    }</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;    v = v1 = Eigen::MatrixXd::Zero(n, n+1);</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;    fv.resize(n+1);idx.resize(n+1);fv1.resize(n+1);</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0;i &lt; n; i++) v(i,0) = pos(i);</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;    tempdip = dipfitError(pos, data, sensors);</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;    fv[0] = tempdip.error;</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    func_evals = 1;itercount = 0;how = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;    <span class="comment">// Continue setting up the initial simplex.</span></div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;    <span class="comment">// Following improvement suggested by L.Pfeffer at Stanford</span></div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    usual_delta = 0.05;             <span class="comment">// 5 percent deltas for non-zero terms</span></div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;    zero_term_delta = 0.00025;      <span class="comment">// Even smaller delta for zero elements of x</span></div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    xin = pos.transpose();</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j = 0;j &lt; n;j++) {</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;        y = xin;</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;        <span class="keywordflow">if</span>(y(j) != 0) y(j) = (1 + usual_delta) * y(j);</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;        <span class="keywordflow">else</span> y(j) = zero_term_delta;</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;        v.col(j+1).array() = y;</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;        pos = y.transpose();</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;        tempdip = dipfitError(pos, data, sensors);</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;        fv[j+1] = tempdip.error;</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    }</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;    <span class="comment">// Sort elements of fv</span></div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;    base_arr = fv;</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; n+1; i++) idx[i] = i;</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;    sort (idx.begin(), idx.end(), RtHPIS::compar);</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0;i &lt; n+1;i++) {</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;        v1.col(i) = v.col(idx[i]);</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;        fv1[i] = fv[idx[i]];</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;    }</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;    v = v1;fv = fv1;</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    how = <span class="stringliteral">&quot;initial simplex&quot;</span>;</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;    itercount = itercount + 1;</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;    func_evals = n + 1;</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;    tempX1 = Eigen::MatrixXd::Zero(1,n);</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    <span class="keywordflow">while</span> ((func_evals &lt; maxfun) &amp;&amp; (itercount &lt; maxiter)) {</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0;i &lt; n;i++) tempX1(i) = abs(fv[0] - fv[i+1]);</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;        temp1 = tempX1.maxCoeff();</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;        tempX2 = Eigen::MatrixXd::Zero(n,n);</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0;i &lt; n;i++) tempX2.col(i) = v.col(i+1) -  v.col(0);</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;        tempX2 = tempX2.array().abs();</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;        temp2 = tempX2.maxCoeff();</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;        <span class="keywordflow">if</span>((temp1 &lt;= tolf) &amp;&amp; (temp2 &lt;= tolx)) <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;        xbar = v.block(0,0,n,n).rowwise().sum();</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;        xbar /= n;</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;        xr = (1+rho) * xbar - rho * v.block(0,n,v.rows(),1);</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;        x = xr.transpose();</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;        <span class="comment">//std::cout &lt;&lt; &quot;Iteration Count: &quot; &lt;&lt; itercount &lt;&lt; &quot;:&quot; &lt;&lt; x &lt;&lt; std::endl;</span></div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;        fxr = dipfitError(x, data, sensors);</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;        func_evals = func_evals+1;</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;        <span class="keywordflow">if</span> (fxr.error &lt; fv[0]) {</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;            <span class="comment">// Calculate the expansion point</span></div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;            xe = (1 + rho * chi) * xbar - rho * chi * v.col(v.cols()-1);</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;            x = xe.transpose();</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;            fxe = dipfitError(x, data, sensors);</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;            func_evals = func_evals+1;</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;            <span class="keywordflow">if</span>(fxe.error &lt; fxr.error) {</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;                v.col(v.cols()-1) = xe;</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;                fv[n] = fxe.error;</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;                how = <span class="stringliteral">&quot;expand&quot;</span>;</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;            }</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;            <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;                v.col(v.cols()-1) = xr;</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;                fv[n] = fxr.error;</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;                how = <span class="stringliteral">&quot;reflect&quot;</span>;</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;            }</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;        }</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;        <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;            <span class="keywordflow">if</span>(fxr.error &lt; fv[n-1]) {</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;                v.col(v.cols()-1) = xr;</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;                fv[n] = fxr.error;</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;                how = <span class="stringliteral">&quot;reflect&quot;</span>;</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;            }</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;            <span class="keywordflow">else</span> { <span class="comment">// fxr.error &gt;= fv[:,n-1]</span></div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;                <span class="comment">// Perform contraction</span></div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;                <span class="keywordflow">if</span>(fxr.error &lt; fv[n]) {</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;                    <span class="comment">// Perform an outside contraction</span></div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;                    xc = (1 + psi * rho) * xbar - psi * rho * v.col(v.cols()-1);</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;                    x = xc.transpose();</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;                    fxc = dipfitError(x, data, sensors);</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;                    func_evals = func_evals + 1;</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;                    <span class="keywordflow">if</span>(fxc.error &lt;= fxr.error) {</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;                        v.col(v.cols()-1) = xc;</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;                        fv[n] = fxc.error;</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;                        how = <span class="stringliteral">&quot;contract outside&quot;</span>;</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;                    }</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;                    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;                        <span class="comment">// perform a shrink</span></div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;                        how = <span class="stringliteral">&quot;shrink&quot;</span>;</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;                    }</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;                }</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;                <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;                    xcc = (1 - psi) * xbar + psi * v.col(v.cols()-1);</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;                    x = xcc.transpose();</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;                    fxcc = dipfitError(x, data, sensors);</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;                    func_evals = func_evals+1;</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;                    <span class="keywordflow">if</span>(fxcc.error &lt; fv[n]) {</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;                        v.col(v.cols()-1) = xcc;</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;                        fv[n] = fxcc.error;</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;                        how = <span class="stringliteral">&quot;contract inside&quot;</span>;</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;                    }</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;                    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;                        <span class="comment">// perform a shrink</span></div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;                        how = <span class="stringliteral">&quot;shrink&quot;</span>;</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;                    }</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;                }</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;                <span class="keywordflow">if</span>(how.compare(<span class="stringliteral">&quot;shrink&quot;</span>) == 0) {</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;                    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j = 1;j &lt; n+1;j++) {</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;                        v.col(j).array() = v.col(0).array() + sigma * (v.col(j).array() - v.col(0).array());</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;                        x = v.col(j).array().transpose();</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;                        tempdip = dipfitError(x,data, sensors);</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;                        fv[j] = tempdip.error;</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;                    }</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;                }</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;            }</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;        }</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;        <span class="comment">// Sort elements of fv</span></div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;        base_arr = fv;</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; n+1; i++) idx[i] = i;</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;        sort (idx.begin (), idx.end (), compar);</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0;i &lt; n+1;i++) {</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;            v1.col(i) = v.col(idx[i]);</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;            fv1[i] = fv[idx[i]];</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;        }</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;        v = v1;fv = fv1;</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;        itercount = itercount + 1;</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    }</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;    x = v.col(0).transpose();</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;    <span class="keywordflow">return</span> x;</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;}</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;<span class="comment">/*********************************************************************************</span></div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;<span class="comment"> * dipfitError computes the error between measured and model data</span></div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;<span class="comment"> * and can be used for non-linear fitting of dipole position.</span></div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;<span class="comment"> * The function has been compared with matlab dipfit_error and it gives</span></div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;<span class="comment"> * same output</span></div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;<span class="comment"> *********************************************************************************/</span></div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;<a class="code" href="struct_r_t_i_n_v_l_i_b_1_1dip_error.html">dipError</a> RtHPIS::dipfitError(Eigen::MatrixXd pos, Eigen::MatrixXd data, <span class="keyword">struct</span> <a class="code" href="struct_r_t_i_n_v_l_i_b_1_1sens.html">sens</a> sensors)</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;{</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;    <span class="comment">// Variable Declaration</span></div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;    <span class="keyword">struct </span><a class="code" href="struct_r_t_i_n_v_l_i_b_1_1dip_error.html">dipError</a> e;</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;    Eigen::MatrixXd lf, dif;</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;    <span class="comment">// Compute lead field for a magnetic dipole in infinite vacuum</span></div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;    lf = ft_compute_leadfield(pos, sensors);</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;    e.moment = pinv(lf) * data;</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;    dif = data - lf * e.moment;</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    e.error = dif.array().square().sum()/data.array().square().sum();</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;    <span class="keywordflow">return</span> e;</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;}</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;<span class="comment">/*********************************************************************************</span></div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;<span class="comment"> * ft_compute_leadfield computes a forward solution for a dipole in a a volume</span></div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;<span class="comment"> * conductor model. The forward solution is expressed as the leadfield</span></div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;<span class="comment"> * matrix (Nchan*3), where each column corresponds with the potential or field</span></div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;<span class="comment"> * distributions on all sensors for one of the x,y,z-orientations of the dipole.</span></div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;<span class="comment"> * The function has been compared with matlab ft_compute_leadfield and it gives</span></div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;<span class="comment"> * same output</span></div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;<span class="comment"> *********************************************************************************/</span></div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;Eigen::MatrixXd RtHPIS::ft_compute_leadfield(Eigen::MatrixXd pos, <span class="keyword">struct</span> <a class="code" href="struct_r_t_i_n_v_l_i_b_1_1sens.html">sens</a> sensors)</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;{</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;    Eigen::MatrixXd pnt, ori, lf;</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;    pnt = sensors.coilpos; <span class="comment">// position of each coil</span></div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    ori = sensors.coilori; <span class="comment">// orientation of each coil</span></div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;    lf = magnetic_dipole(pos, pnt, ori);</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    lf = sensors.tra * lf;</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;    <span class="keywordflow">return</span> lf;</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;}</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;<span class="comment">/*********************************************************************************</span></div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;<span class="comment"> * magnetic_dipole leadfield for a magnetic dipole in an infinite medium</span></div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;<span class="comment"> * The function has been compared with matlab magnetic_dipole and it gives same output</span></div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;<span class="comment"> *********************************************************************************/</span></div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;Eigen::MatrixXd RtHPIS::magnetic_dipole(Eigen::MatrixXd pos, Eigen::MatrixXd pnt, Eigen::MatrixXd ori) {</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;    <span class="keywordtype">double</span> u0 = 1e-7;</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;    <span class="keywordtype">int</span> nchan;</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;    Eigen::MatrixXd r, r2, r5, x, y, z, mx, my, mz, Tx, Ty, Tz, lf, temp;</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    nchan = pnt.rows();</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    <span class="comment">// Shift the magnetometers so that the dipole is in the origin</span></div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;    pnt.array().col(0) -= pos(0);pnt.array().col(1) -= pos(1);pnt.array().col(2) -= pos(2);</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;    r = pnt.array().square().rowwise().sum().sqrt();</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;   r2 = r5 = x = y = z = mx = my = mz = Tx = Ty = Tz = lf = Eigen::MatrixXd::Zero(nchan,3);</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0;i &lt; nchan;i++) {</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;            r2.row(i).array().fill(pow(r(i),2));</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;            r5.row(i).array().fill(pow(r(i),5));</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;    }</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0;i &lt; nchan;i++) {</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;        x.row(i).array().fill(pnt(i,0));</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;        y.row(i).array().fill(pnt(i,1));</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;        z.row(i).array().fill(pnt(i,2));</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;    }</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;    mx.col(0).array().fill(1);my.col(1).array().fill(1);mz.col(2).array().fill(1);</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;    Tx = 3 * x.cwiseProduct(pnt) - mx.cwiseProduct(r2);</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;    Ty = 3 * y.cwiseProduct(pnt) - my.cwiseProduct(r2);</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;    Tz = 3 * z.cwiseProduct(pnt) - mz.cwiseProduct(r2);</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0;i &lt; nchan;i++) {</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;        lf(i,0) = Tx.row(i).dot(ori.row(i));</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;        lf(i,1) = Ty.row(i).dot(ori.row(i));</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;        lf(i,2) = Tz.row(i).dot(ori.row(i));</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;    }</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0;i &lt; nchan;i++) {</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j = 0;j &lt; 3;j++) {</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;            lf(i,j) = u0 * lf(i,j)/(4 * M_PI * r5(i,j));</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;        }</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    }</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;    <span class="keywordflow">return</span> lf;</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;}</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;<span class="keywordtype">bool</span> RtHPIS::compar (<span class="keywordtype">int</span> a, <span class="keywordtype">int</span> b){</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;  <span class="keywordflow">return</span> ((base_arr)[a] &lt; (base_arr)[b]);</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;}</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;Eigen::Matrix4d RtHPIS::computeTransformation(Eigen::MatrixXd NH, Eigen::MatrixXd BT)</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;{</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    Eigen::MatrixXd xdiff, ydiff, zdiff, C, Q;</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;    Eigen::Matrix4d trans = Eigen::Matrix4d::Identity(4,4), Rot = Eigen::Matrix4d::Zero(4,4), Trans = Eigen::Matrix4d::Identity(4,4);</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    <span class="keywordtype">double</span> meanx,meany,meanz,normf;</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0;i &lt; 15;i++) {</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;        zdiff = NH.col(2) - BT.col(2);</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;        ydiff = NH.col(1) - BT.col(1);</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;        xdiff = NH.col(0) - BT.col(0);</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;</div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;        meanx=xdiff.mean();</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;        meany=ydiff.mean();</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;        meanz=zdiff.mean();</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0;j&lt;NH.rows();j++) {</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;            BT(j,0) = BT(j,0) + meanx;</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;            BT(j,1) = BT(j,1) + meany;</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;            BT(j,2) = BT(j,2) + meanz;</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;        }</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;        C = BT.transpose() * NH;</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;        Eigen::JacobiSVD&lt; Eigen::MatrixXd &gt; svd(C ,Eigen::ComputeThinU | Eigen::ComputeThinV);</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;        Q = svd.matrixU() * svd.matrixV().transpose();</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;        BT = BT * Q;</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;        normf = (NH.transpose()-BT.transpose()).norm();</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;3;j++) {</div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k=0;k&lt;3;k++) Rot(j,k) = Q(k,j);</div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;        }</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;        Rot(3,3) = 1;</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;        Trans(0,3) = meanx;Trans(1,3) = meany;Trans(2,3) = meanz;</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;        trans = Rot * Trans * trans;</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;    }</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;    <span class="keywordflow">return</span> trans;</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;}</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;Eigen::MatrixXd RtHPIS::pinv(Eigen::MatrixXd a)</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;{</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;    <span class="keywordtype">double</span> epsilon = std::numeric_limits&lt;double&gt;::epsilon();</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;    Eigen::JacobiSVD&lt; Eigen::MatrixXd &gt; svd(a ,Eigen::ComputeThinU | Eigen::ComputeThinV);</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    <span class="keywordtype">double</span> tolerance = epsilon * std::max(a.cols(), a.rows()) * svd.singularValues().array().abs()(0);</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    <span class="keywordflow">return</span> svd.matrixV() * (svd.singularValues().array().abs() &gt; tolerance).select(svd.singularValues().array().inverse(),0).matrix().asDiagonal() * svd.matrixU().adjoint();</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;}</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;std::vector &lt;double&gt;RtHPIS::base_arr;</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;</div>
<div class="ttc" id="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s_html_a3ea8e716042e66608367190f19244a2a"><div class="ttname"><a href="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s.html#a3ea8e716042e66608367190f19244a2a">RTINVLIB::RtHPIS::isRunning</a></div><div class="ttdeci">bool isRunning()</div><div class="ttdef"><b>Definition:</b> <a href="rthpis_8h_source.html#l00257">rthpis.h:257</a></div></div>
<div class="ttc" id="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s_html_a006c97dcf82c0654a63c75a5857887de"><div class="ttname"><a href="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s.html#a006c97dcf82c0654a63c75a5857887de">RTINVLIB::RtHPIS::run</a></div><div class="ttdeci">virtual void run()</div><div class="ttdef"><b>Definition:</b> <a href="rthpis_8cpp_source.html#l00140">rthpis.cpp:140</a></div></div>
<div class="ttc" id="struct_r_t_i_n_v_l_i_b_1_1dip_error_html"><div class="ttname"><a href="struct_r_t_i_n_v_l_i_b_1_1dip_error.html">RTINVLIB::dipError</a></div><div class="ttdef"><b>Definition:</b> <a href="rthpis_8h_source.html#l00110">rthpis.h:110</a></div></div>
<div class="ttc" id="class_i_o_buffer_1_1_circular_matrix_buffer_html_a27289313f8c9d93db4e02703e2033e8f"><div class="ttname"><a href="class_i_o_buffer_1_1_circular_matrix_buffer.html#a27289313f8c9d93db4e02703e2033e8f">IOBuffer::CircularMatrixBuffer::SPtr</a></div><div class="ttdeci">QSharedPointer&lt; CircularMatrixBuffer &gt; SPtr</div><div class="ttdef"><b>Definition:</b> <a href="circularmatrixbuffer_8h_source.html#l00096">circularmatrixbuffer.h:96</a></div></div>
<div class="ttc" id="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s_html_a8bf331e20556363f55a76c91f36e704b"><div class="ttname"><a href="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s.html#a8bf331e20556363f55a76c91f36e704b">RTINVLIB::RtHPIS::~RtHPIS</a></div><div class="ttdeci">~RtHPIS()</div><div class="ttdef"><b>Definition:</b> <a href="rthpis_8cpp_source.html#l00087">rthpis.cpp:87</a></div></div>
<div class="ttc" id="class_i_o_buffer_1_1_circular_matrix_buffer_html"><div class="ttname"><a href="class_i_o_buffer_1_1_circular_matrix_buffer.html">IOBuffer::CircularMatrixBuffer&lt; double &gt;</a></div></div>
<div class="ttc" id="class_f_i_f_f_l_i_b_1_1_fiff_info_html_abfce6128814de61b3fdd324a97918338"><div class="ttname"><a href="class_f_i_f_f_l_i_b_1_1_fiff_info.html#abfce6128814de61b3fdd324a97918338">FIFFLIB::FiffInfo::SPtr</a></div><div class="ttdeci">QSharedPointer&lt; FiffInfo &gt; SPtr</div><div class="ttdef"><b>Definition:</b> <a href="fiff__info_8h_source.html#l00099">fiff_info.h:99</a></div></div>
<div class="ttc" id="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s_html_a5df30063b75193a9b2cb50058d68cc41"><div class="ttname"><a href="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s.html#a5df30063b75193a9b2cb50058d68cc41">RTINVLIB::RtHPIS::start</a></div><div class="ttdeci">virtual bool start()</div><div class="ttdef"><b>Definition:</b> <a href="rthpis_8cpp_source.html#l00109">rthpis.cpp:109</a></div></div>
<div class="ttc" id="class_i_o_buffer_1_1_circular_matrix_buffer_html_adbba1720803e03e6b1bcd6b37f884f09"><div class="ttname"><a href="class_i_o_buffer_1_1_circular_matrix_buffer.html#adbba1720803e03e6b1bcd6b37f884f09">IOBuffer::CircularMatrixBuffer::push</a></div><div class="ttdeci">void push(const Matrix&lt; _Tp, Dynamic, Dynamic &gt; *pMatrix)</div><div class="ttdef"><b>Definition:</b> <a href="circularmatrixbuffer_8h_source.html#l00236">circularmatrixbuffer.h:236</a></div></div>
<div class="ttc" id="class_i_o_buffer_1_1_circular_matrix_buffer_html_a2a2115cde980084c54c138b00b3a2273"><div class="ttname"><a href="class_i_o_buffer_1_1_circular_matrix_buffer.html#a2a2115cde980084c54c138b00b3a2273">IOBuffer::CircularMatrixBuffer::releaseFromPop</a></div><div class="ttdeci">bool releaseFromPop()</div><div class="ttdef"><b>Definition:</b> <a href="circularmatrixbuffer_8h_source.html#l00341">circularmatrixbuffer.h:341</a></div></div>
<div class="ttc" id="class_i_o_buffer_1_1_circular_matrix_buffer_html_ad22568c8be8da160dd52a98cf5f4fd46"><div class="ttname"><a href="class_i_o_buffer_1_1_circular_matrix_buffer.html#ad22568c8be8da160dd52a98cf5f4fd46">IOBuffer::CircularMatrixBuffer::pop</a></div><div class="ttdeci">Matrix&lt; _Tp, Dynamic, Dynamic &gt; pop()</div><div class="ttdef"><b>Definition:</b> <a href="circularmatrixbuffer_8h_source.html#l00257">circularmatrixbuffer.h:257</a></div></div>
<div class="ttc" id="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s_html_a990146f0f4a71f08116a4602d1d5918e"><div class="ttname"><a href="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s.html#a990146f0f4a71f08116a4602d1d5918e">RTINVLIB::RtHPIS::stop</a></div><div class="ttdeci">virtual bool stop()</div><div class="ttdef"><b>Definition:</b> <a href="rthpis_8cpp_source.html#l00124">rthpis.cpp:124</a></div></div>
<div class="ttc" id="rthpis_8h_html"><div class="ttname"><a href="rthpis_8h.html">rthpis.h</a></div><div class="ttdoc">RtHPIS class declaration. </div></div>
<div class="ttc" id="namespace_f_i_f_f_l_i_b_html"><div class="ttname"><a href="namespace_f_i_f_f_l_i_b.html">FIFFLIB</a></div><div class="ttdef"><b>Definition:</b> <a href="fiff_8h_source.html#l00098">fiff.h:98</a></div></div>
<div class="ttc" id="namespace_r_t_i_n_v_l_i_b_html"><div class="ttname"><a href="namespace_r_t_i_n_v_l_i_b.html">RTINVLIB</a></div><div class="ttdef"><b>Definition:</b> <a href="rtave_8h_source.html#l00093">rtave.h:93</a></div></div>
<div class="ttc" id="struct_r_t_i_n_v_l_i_b_1_1coil_param_html"><div class="ttname"><a href="struct_r_t_i_n_v_l_i_b_1_1coil_param.html">RTINVLIB::coilParam</a></div><div class="ttdef"><b>Definition:</b> <a href="rthpis_8h_source.html#l00105">rthpis.h:105</a></div></div>
<div class="ttc" id="struct_r_t_i_n_v_l_i_b_1_1sens_html"><div class="ttname"><a href="struct_r_t_i_n_v_l_i_b_1_1sens.html">RTINVLIB::sens</a></div><div class="ttdef"><b>Definition:</b> <a href="rthpis_8h_source.html#l00115">rthpis.h:115</a></div></div>
<div class="ttc" id="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s_html_a708952fe3f8738f99d383d8c8d136827"><div class="ttname"><a href="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s.html#a708952fe3f8738f99d383d8c8d136827">RTINVLIB::RtHPIS::append</a></div><div class="ttdeci">void append(const MatrixXd &amp;p_DataSegment)</div><div class="ttdef"><b>Definition:</b> <a href="rthpis_8cpp_source.html#l00097">rthpis.cpp:97</a></div></div>
<div class="ttc" id="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s_html_a8f482816342d7e85c7d5fa3e592c486b"><div class="ttname"><a href="class_r_t_i_n_v_l_i_b_1_1_rt_h_p_i_s.html#a8f482816342d7e85c7d5fa3e592c486b">RTINVLIB::RtHPIS::RtHPIS</a></div><div class="ttdeci">RtHPIS(FiffInfo::SPtr p_pFiffInfo, QObject *parent=0)</div><div class="ttdef"><b>Definition:</b> <a href="rthpis_8cpp_source.html#l00073">rthpis.cpp:73</a></div></div>
<div class="ttc" id="class_i_o_buffer_1_1_circular_matrix_buffer_html_af61689beb6325a34564e76ccc674487a"><div class="ttname"><a href="class_i_o_buffer_1_1_circular_matrix_buffer.html#af61689beb6325a34564e76ccc674487a">IOBuffer::CircularMatrixBuffer::clear</a></div><div class="ttdeci">void clear()</div><div class="ttdef"><b>Definition:</b> <a href="circularmatrixbuffer_8h_source.html#l00290">circularmatrixbuffer.h:290</a></div></div>
<div class="ttc" id="fiff__cov_8h_html"><div class="ttname"><a href="fiff__cov_8h.html">fiff_cov.h</a></div><div class="ttdoc">FiffCov class declaration. </div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Oct 22 2015 18:45:22 for MNE-CPP by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
